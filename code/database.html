<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Grid</title>
    <script src="https://cdn.zinggrid.com/zinggrid.min.js" defer></script>
    <style>
        zing-grid {
            --zg-caption-background: burlywood;
            --zg-caption-color: black;
            --zg-captio-font-family: 'Times New Roman', Times, serif;
            --zg-caption-title-text-align: center;
        }
    </style>
</head>
<body>
    <zing-grid caption="User Sessions"
        sort search pager page-size=3 page-size-options="2, 3, 6"
        src="https://gilkeidar.com/api/user-sessions"
    ></zing-grid>

    <zing-grid id="user-activity" sort search pager page-size=6 
        page-size-options="2, 3, 6, 10">
        <zg-caption>User Activity (in bursts of 10 seconds)</zg-caption>
        <zg-colgroup>
            <zg-column type="text" index="Session Id"></zg-column>
            <zg-column type="text" index="Event"></zg-column>
            <zg-column type="number" index="Timestamp"></zg-column>
            <zg-column type="element" type-element-tag-name="pre" index="Event Information"></zg-column>
        </zg-colgroup>
    </zing-grid>

<script>
    async function setActivityGridData(activityGrid) {
        //  1.  Get user activity data (populate grid)
        const response = await fetch("https://gilkeidar.com/api/activity-bursts");
        const data = await response.json();
        // console.log(data);

        let gridData = [];

        for (let activity_burst of data) {
            for (let activityData of activity_burst.activity) {
                gridData.push({
                    "Session Id": activity_burst.session_id,
                    "Event": activityData.event_name,
                    "Timestamp": activityData.time_stamp,
                    "Event Information": JSON.stringify(activityData.event_info, null, 2)
                });
            }
        }

        activityGrid.setData(gridData);
    }

    addEventListener("load", async (e) => {
        const activityGrid = document.querySelector('#user-activity');

        setActivityGridData(activityGrid);

        let lastRefreshTime = Date.now();

        activityGrid.addEventListener('grid:refresh', (e) => {
            console.log("grid:refresh event fired.");
            console.log(e);

            //  Avoid infinite event loop, since setActivityGridData() triggers
            //  the grid:refresh event.
            //  1.  User clicks refresh button.
            //  2.  grid:refresh event is triggered, and this event handler is
            //      run.
            //  3.  Let t be the current time and t_0 be last time grid:refresh
            //          fired where setActivityGridData() was called.
            //  4.  If t - t_0 > x:
            //      1.  Set t_0 to t.
            //      2.  setActivityGridData() is called.
            //  5.  Since setActivityGridData() is called, grid:refresh is
            //      triggered again.
            //  6.  Let t' be the current time and t is the last time that
            //          grid:refresh fired where setActivityGridData() was
            //          called.
            //  7.  x should be chosen so that t' - t <= x (to avoid calling
            //          setActivityGridData() again without cause).
            //      *   x should therefore be some multiple of the time it takes
            //          to run setActivityGridData().
            //          This is tricky, since it makes a network request.
            //          I thus chose x to be a large number (10 seconds).
            if (Date.now() - lastRefreshTime > 10000) {
                console.log("Updating data.");
                lastRefreshTime = Date.now();
                setActivityGridData(activityGrid);
            }
        })
    });
</script>
</body>
</html>