<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Grid</title>
    <script src="https://cdn.zinggrid.com/zinggrid.min.js" defer></script>
</head>
<body>
    <zing-grid caption="User Sessions"
        sort search pager page-size=3 page-size-options="2, 3, 6"
        src="https://gilkeidar.com/api/user-sessions"
    ></zing-grid>
    <!-- <zing-grid caption="User Activity (in bursts of 10 seconds)"
        sort search pager page-size=3 page-size-options="2, 3, 6"
        src="https://gilkeidar.com/api/activity-bursts"
    ></zing-grid> -->

    <zing-grid id="user-activity" sort search pager page-size=6 
        page-size-options="2, 3, 6, 10">
        <zg-caption>User Activity (in bursts of 10 seconds)</zg-caption>
        <zg-colgroup>
            <zg-column type="text" index="Session Id"></zg-column>
            <zg-column type="text" index="Event"></zg-column>
            <zg-column type="number" index="Timestamp"></zg-column>
            <zg-column type="element" type-element-tag-name="pre" index="Event Information"></zg-column>
        </zg-colgroup>
    </zing-grid>

<script>
    async function setActivityGridData(activityGrid) {
        //  1.  Get user activity data (populate grid)
        const response = await fetch("https://gilkeidar.com/api/activity-bursts");
        const data = await response.json();
        // console.log(data);

        let gridData = [];

        for (let activity_burst of data) {
            for (let activityData of activity_burst.activity) {
                gridData.push({
                    "Session Id": activity_burst.session_id,
                    "Event": activityData.event_name,
                    "Timestamp": activityData.time_stamp,
                    "Event Information": JSON.stringify(activityData.event_info, null, 2)
                });
            }
        }

        activityGrid.setData(gridData);
    }

    addEventListener("load", async (e) => {
        const activityGrid = document.querySelector('#user-activity');

        setActivityGridData(activityGrid);

        let lastRefreshTime = Date.now();

        activityGrid.addEventListener('grid:refresh', (e) => {
            console.log("grid:refresh event fired.");
            console.log(e);

            if (Date.now() - lastRefreshTime > 10000) {
                console.log("Updating data.");
                lastRefreshTime = Date.now();
                setActivityGridData(activityGrid);
            }

            // console.log("grid:beforerender event fired.");
            // setActivityGridData(activityGrid);
        })
        

        // for (let activity_burst of data) {
        //     for (let activityData of activity_burst.activity) {
        //         activityGrid.insertRow({
        //             "Session Id": activity_burst.session_id,
        //             "Event": activityData.event_name,
        //             "Timestamp": activityData.time_stamp,
        //             "Event Information": JSON.stringify(activityData.event_info, null, 2)
        //         });
        //     }
        // }
    });
</script>
</body>
</html>