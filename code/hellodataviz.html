<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hello Data Visualization</title>
    <script src="https://cdn.zingchart.com/zingchart.min.js"></script>
</head>
<body>
    <div id="sessions-visitors-and-errors"></div>
    <div id="accesses-and-entry-points"></div>
    <!-- <div id="chartizard"></div> -->
    <!-- <div id="chartmeleon"></div> -->
    <script>
        function generateTimeScaleText(numDays) {
            let scaleText = [];
            for (let i = 0; i < numDays; i++) {
                if (i == numDays - 1) {
                    scaleText.push('Today');
                } else if (i == numDays - 2) {
                    scaleText.push('Yesterday');
                } 
                else {
                    scaleText.push(`${numDays - 1 - i} ds ago`);
                }
            }

            return scaleText;
        }

        // function renderLineChart(t_start, t_end) {
        async function renderLineChart(activity, sessionArray) {
            console.log("renderLineChart()");
            //  Line chart specification
            //  x-axis: Time, discrete (units in days)
            //  y-axis: # of occurrences (per day)
            //  Three series:
            //      1.  # of errors / day (red)
            //      2.  # of unique visitors / day (green)
            //      3.  # of sessions / day (blue)

            //  1.  # of errors / day
            //  This can be tracked by reading in ActivityData (from t_start to
            //      t_end)
            
            //  1.  # of errors / day
            //  1.  Create an array of length 30 representing one month.
            //      (where index 0 is 29 days ago and index 29 is today).
            //  2.  Send a GET request to /api/activity-bursts to get a JSON
            //      array of all ActivityBursts; store the array in the variable
            //      activity.
            //  3.  Iterate through every ActivityBurst and through every
            //      ActivityData object; if the activity event type is an error,
            //      then:
            //      1.  Determine the day of when the error happened from its
            //          timestamp, converting it into an index in the array.
            //      2.  Increment the value in the array.
            //  4.  The array now represents the series 1 data.

            //  1.  Create three arrays of length 30 representing one month,
            //      each of which containing the series 1, 2, and 3 data
            //      respectively.

            //  Data is for 30 days (29 days ago to today)
            let numDays = 30;

            let scaleText = generateTimeScaleText(numDays);

            let errors = Array(numDays).fill(0);
            let visitors = Array(numDays).fill(0);
            let sessions = Array(numDays).fill(0);

            //  1.  Fill errors series
            //      1.  Send a GET request to /api/activity-bursts to get a JSON
            //          array of all ActivityBursts in the database, and store
            //          the array in the variable activity.
            //      2.  For every ActivityBurst burst in activity:
            //          1.  For every ActivityData activityData in burst:
            //              1.  If activityData represents an error:
            //                  1.  Determine the day when activityData happened
            //                      (as an index in the errors array).
            //                  2.  Increment errors[index] (or set it to 1 if
            //                      it is null).
            


            for (let activityBurst of activity) {
                for (let activityData of activityBurst.activity) {
                    if (activityData.event_name.includes('error')) {
                        //  Found an error activity event!
                        console.log("Found error!");
                        let error_time = new Date(activityData.time_stamp);
                        let time_diff = Date.now() - error_time;
                        let day_diff = Math.floor(time_diff / (1000 * 60 * 60 * 24));
                        let day_index = numDays - 1 - day_diff;

                        if (errors[day_index] == null) {
                            errors[day_index] = 1;
                        } else {
                            errors[day_index]++;
                        }
                    }
                }
            }

            //  2.  Fill visitors series (Number of visitors per day)
            //  3.  Fill sessions series (Number of sessions per day)
            //      1.  Create an array of length numDays of sets of userIDs
            //          (each index starting as an empty set) (call this 
            //          uniqueVisitors).
            //      1.  Send a GET request to /api/user-sessions to get a JSON
            //          array of all UserSessions and store it in sessionArray.
            //      2.  For each session:
            //          1.  Determine the day it occurred.
            //          2.  sessions[day]++.
            //          3.  If user ID of the session doesn't exist in 
            //              uniqueVisitors, add it.
            //      3.  For i = 0 to numDays - 1:
            //          1.  visitors[i] = uniqueVisitors[i].size();
            let uniqueVisitors = Array(numDays).fill(null);

            for (let session of sessionArray) {
                let session_time = session.performance_data["page-load-end"];
                let time_diff = Date.now() - session_time;
                let day_diff = Math.floor(time_diff / (1000 * 60 * 60 * 24));
                let day_index = numDays - 1 - day_diff;

                if (sessions[day_index] == null) {
                    sessions[day_index] = 1;
                }
                else {
                    sessions[day_index]++;
                }

                if (uniqueVisitors[day_index] == null) {
                    uniqueVisitors[day_index] = new Set();
                }
                uniqueVisitors[day_index].add(session.user_id);
            }

            for (let i = 0; i < numDays; i++) {
                if (uniqueVisitors[i] != null) {
                    visitors[i] = uniqueVisitors[i].size;
                }
            }

            

            //  4.  Render line chart
            let lineConfig = {
                theme: 'dark',
                type: 'line',
                title: {
                    text: 'Sessions, Visitors, and Errors',
                    fontSize: 24
                },
                legend: {
                    draggable: true
                },
                scaleX: {
                    label: {text: 'Days'},
                    labels: scaleText
                },
                scaleY: {
                    step: 1
                },
                series: [
                    {
                        values: errors,
                        text: '# Errors',
                        lineColor: "darkred",
                        marker: {
                            size: 7,
                            backgroundColor: 'red',
                            borderColor: 'darkred',
                            borderWidth: '1px'
                        }
                    },
                    {
                        values: visitors,
                        text: '# Visitors',
                        lineColor: "darkgreen",
                        marker: {
                            size: 7,
                            backgroundColor: 'green',
                            borderColor: 'darkgreen',
                            borderWidth: '1px'
                        }
                    },
                    {
                        values: sessions,
                        text: '# Sessions (Visits)',
                        lineColor: "lightblue",
                        marker: {
                            size: 7,
                            backgroundColor: 'DeepSkyBlue',
                            borderColor: 'lightblue',
                            borderWidth: '1px'
                        }
                    }
                ]
            };

            zingchart.render({
                id: 'sessions-visitors-and-errors',
                data: lineConfig
            });
        }

        async function renderBarChart(activity, sessionArray) {
            console.log("renderBarChart()");
            //  Line chart specification
            //  x-axis: pages in site that have been accessed
            //  y-axis: # of occurrences (over the time period of data queried)
            //  Two series:
            //      1.  # of accesses
            //      2.  # of accesses as an entry point

            //  1.  Create an object of key-value pairs where the key is the
            //      URL and the value is an object with property for numAccesses
            //      and numEntryPointAccesses.
            let pageAccesses = {};
            //  2.  Start by iterating through sessionArray then activityData
            for (let session of sessionArray) {
                let url = session.static_data["entry-point"];

                if (url in pageAccesses) {
                    pageAccesses[url].numEntryPointAccesses++;
                } else {
                    //  NOTE: The reason numAccesses is counted as 0 here and
                    //  not 1 is to avoid double counting, since when a page is
                    //  opened, the entry point access is counted by the
                    //  UserSessions.static_data["entry-point"] property while
                    //  the access is also counted by an visibilitychange event.
                    //  We shall count the visibilitychange events separately.
                    pageAccesses[url] = {
                        numAccesses: 0,
                        numEntryPointAccesses: 1
                    };
                }
            }

            for (let activityBurst of activity) {
                for (let activityData of activityBurst.activity) {
                    if (activityData.event_name.includes("visibilitychange")) {
                        let event_info = activityData.event_info;

                        if (event_info.userAction.includes("Entered Page")) {
                            console.log("Found access!");

                            let url = event_info.page;

                            if (url in pageAccesses) {
                                pageAccesses[url].numAccesses++;
                            }
                            else {
                                pageAccesses[url] = {
                                    numAccesses: 1,
                                    numEntryPointAccesses: 0
                                };
                            }
                        }
                    }
                }
            }

            console.log(pageAccesses);

            let pages = [];
            let numAccesses =[];
            let numEntryPointAccesses = [];

            for (const url in pageAccesses) {
                pages.push(url);
                numAccesses.push(pageAccesses[url].numAccesses);
                numEntryPointAccesses.push(pageAccesses[url].numEntryPointAccesses);
            }

            let barConfig = {
                type: 'bar',
                title: {
                    text: 'Page Accesses and Entry Points',
                    fontSize: 24
                },
                legend: {
                    draggable: true
                },
                scaleX: {
                    label: {text: 'Page URLs'},
                    labels: pages
                },
                scaleY: {
                    step: 1
                },
                series: [
                    {
                        values: numAccesses,
                        text: '# Accesses'
                    },
                    {
                        values: numEntryPointAccesses,
                        text: '# Entry Point Accesses'
                    }
                ]
            };

            zingchart.render({
                id: 'accesses-and-entry-points',
                data: barConfig
            });

        }

        addEventListener('load', async e => {
            //  Time start and end
            // let t_start, t_end;

            //  Start last month, end now
            // t_end = Date.now();
            // t_start = t_end - (1000 * 60 * 60 * 24 * 30);

            // renderLineChart(t_start, t_end);

            //  For now, just use all of the data without worrying about time
            //  periods.

            //  1.  Query UserSessions and ActivityBurst data.

            let response = await fetch('https://gilkeidar.com/api/activity-bursts');
            let activity = await response.json();
            // let activity = [
            //     {
            //         "_id": "68b5e4b39703a76669c609fc",
            //         "burst_start": 1756751016146,
            //         "burst_end": 1756751016146,
            //         "activity": [
            //             {
            //                 "event_name": "visibilitychange",
            //                 "time_stamp": 1756751016146,
            //                 "event_info": {
            //                 "userAction": "Entered Page",
            //                 "page": "https://gilkeidar.com/"
            //                 }
            //             },
            //             {
            //                 "event_name": "error",
            //                 "time_stamp": 1756751016146
            //             }
            //         ],
            //         "session_id": "XIuyW2QrZsxghshnTjT6"
            //     }
            // ];

            response = await fetch("https://gilkeidar.com/api/user-sessions");
            let sessionArray = await response.json();
            // let sessionArray = [
            //     {
            //         "_id": "XIuyW2QrZsxghshnTjT6",
            //         "static_data": {
            //         "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36",
            //         "user-language": "en-US",
            //         "user-accepts-cookies": true,
            //         "user-allows-javascript": true,
            //         "user-allows-images": true,
            //         "user-allows-css": true,
            //         "user-screen-dimensions": {
            //             "width": 1646,
            //             "height": 926
            //         },
            //         "user-window-dimensions": {
            //             "width": 1646,
            //             "height": 757
            //         },
            //         "user-network-connection-type": "4g"
            //         },
            //         "performance_data": {
            //         "timing-object": {
            //             "connectStart": 1756751015680,
            //             "secureConnectionStart": 1756751015709,
            //             "unloadEventEnd": 0,
            //             "domainLookupStart": 1756751015680,
            //             "domainLookupEnd": 1756751015680,
            //             "responseStart": 1756751015789,
            //             "connectEnd": 1756751015748,
            //             "responseEnd": 1756751015791,
            //             "requestStart": 1756751015748,
            //             "domLoading": 1756751015798,
            //             "redirectStart": 0,
            //             "loadEventEnd": 1756751016143,
            //             "domComplete": 1756751016143,
            //             "navigationStart": 1756751015654,
            //             "loadEventStart": 1756751016143,
            //             "domContentLoadedEventEnd": 1756751015859,
            //             "unloadEventStart": 0,
            //             "redirectEnd": 0,
            //             "domInteractive": 1756751015859,
            //             "fetchStart": 1756751015666,
            //             "domContentLoadedEventStart": 1756751015859
            //         },
            //         "page-load-start": 1756751016143,
            //         "page-load-end": 1756751016143,
            //         "page-load-time": 0
            //         },
            //         "user_id": "kGlTlrWaqTDypr1jrt99"
            //     }
            // ];


            //  Render today's data (going back at most 30 days)
            renderLineChart(activity, sessionArray);

            renderBarChart(activity, sessionArray);
        });

        // addEventListener('load', e => {
        //     let config1 = {
        //         type: 'bar',
        //         title: {
        //             text: 'Data Basics',
        //             fontSize: 24
        //         },
        //         legend: {
        //             draggable: true
        //         },
        //         scaleX: {
        //             //  Set scale label
        //             label: { text: 'Days'},
        //             //  Convert text on scale indices
        //             labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']
        //         },
        //         scaleY: {
        //             //  Scale label with unicode character
        //             label: { text: 'Temperature (°F)'},
        //         },
        //         plot: {
        //             //  Animation
        //             animation: {
        //                 effect: 'ANIMATION_EXPAND_BOTTOM',
        //                 method: 'ANIMATION_STRONG_EASE_OUT',
        //                 sequence: 'ANIMATION_BY_NODE',
        //                 speed: 275
        //             }
        //         },
        //         series: [
        //             {
        //                 //  plot 1 values, linear data
        //                 values: [23, 20, 27, 29, 25, 17, 15],
        //                 text: 'Week 1'
        //             },
        //             {
        //                 //  plot 2 values, linear data
        //                 values: [35, 42, 33, 49, 35, 47, 35],
        //                 text: 'Week 2'
        //             },
        //             {
        //                 //  plot 3 values, linear data
        //                 values: [15, 22, 13, 33, 44, 27, 31],
        //                 text: "Week 3"
        //             }
        //         ]
        //     };

        //     let config2 = {
        //         type: "line",
        //         series: [
        //         {
        //             values: [20, 40, 25, 50, 15, 45, 33, 34]
        //         },
        //         {
        //             values: [5, 30, 21, 18, 59, 50, 28, 33]
        //         }
        //         ]
        //     }

        //     //  Render
        //     zingchart.render({
        //         id: 'chartizard',
        //         data: config1
        //     });
            
        //     zingchart.render({
        //         id: "chartmeleon",
        //         data: config2
        //     })
        // });
    </script>
</body>
</html>