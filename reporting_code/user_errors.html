<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Errors Deep Dive</title>
    <link rel="icon" href="/assets/favicon.ico">
    <link rel="stylesheet" href="/style/global.css">
    <script src="https://cdn.zingchart.com/zingchart.min.js" defer></script>
    <script src="https://cdn.zinggrid.com/zinggrid.min.js" defer></script>
</head>
<body>
    <header>
        <h1>Detailed Report on User Errors</h1>
    </header>
    <main>
        <section style="background-color: wheat">
            <h2>User Errors Deep Dive</h2>
            <p>
                <strong>Question:</strong> For each page <code>p</code>, what
                errors have been thrown and what is their breakdown by type?
            </p>
            <p>
                We have partially answered this question in the dashboard by
                looking at the number of errors logged per page in a bar chart
                and a grid that provides a listing of error events that have
                been recorded client-side (using the <code>collector.js</code>
                script).
            </p>
            <p>
                However, a more detailed analysis (mini-dashboard) can be done
                using the following per page that has at least one error:
                <ol>
                    <li>
                        A number showing the number of errors that occurred on
                        that page.
                        <ul>
                            <li>
                                This helps give a sense of how error-prone the
                                page is.
                            </li>
                        </ul>
                    </li>
                    <li>
                        A pie chart showing the breakdown of error events by
                        event type.
                        <ul>
                            <li>
                                This lets the developer / administrator know
                                what kind of errors have been logged at a
                                glance (e.g., <code>console_error</code> vs.
                                <code>error</code>).
                            </li>
                        </ul>
                    </li>
                    <li>
                        A bar chart showing the frequency of each particular
                        error event (to see which errors happen the most often);
                        this is helpful assuming that some error messages are
                        repeated.
                        <ul>
                            <li>
                                <strong>x-axis:</strong> Error event message
                                string.
                            </li>
                            <li>
                                <strong>y-axis:</strong> Frequency of each error
                                event message string (as it appears in the 
                                data).
                            </li>
                        </ul>
                    </li>
                    <li>
                        A grid that contains a listing of the error events that
                        occurred on that page.
                        <ul>
                            <li>
                                This allows for a deeper dive into the errors
                                that have occurred on that page (this is
                                essentially allowing for raw data consumption
                                and so is added last since it's only relevant
                                if the developer / administrator wants to
                                critically analyze the errors that have occurred
                                on this particular page)
                            </li>
                        </ul>
                    </li>
                </ol>
            </p>
            <p>
                Below, a section will be added for each page's metrics, assuming
                it had logged at least one error. These will be sorted in
                descending order of page error rate.
            </p>
            <p><em>Note to the TA:</em> There might be some easter eggs in those
                error logs...</p>
        </section>
    </main>
    <script>
        let uniqueIdCounter = 1;

        function isErrorEvent(activityData) {
            return activityData.event_name.includes("error");
        }

        function createPieChart(page) {
            //  Create Pie chart showing breakdown of events by type
            console.log(`createPieChart(${page.page})`);
            console.log(page);

            let errorTypes = {};
            for (let error of page.errors) {
                if (error.event_name in errorTypes) {
                    errorTypes[error.event_name]++;
                } else {
                    errorTypes[error.event_name] = 1;
                }
            }

            let series = [];

            for (let errorType in errorTypes) {
                let percent = 
                    Math.floor((errorTypes[errorType] / page.numErrors) * 10000) / 100;
                series.push({
                    text: errorType,
                    values: [errorTypes[errorType] / page.numErrors],
                    tooltip: {
                        text: `${percent}% of errors are of type ${errorType}.`
                    }
                });
            }

            return {
                type: "pie",
                title: {
                    text: "Error Type Breakdown"
                },
                legend: {
                    draggable: true
                },
                series: series
            };
        }

        function getErrorMessage(error) {
            if ("event_info" in error) {
                if ("message" in error.event_info) {
                    return error.event_info.message;
                }
                if ("arguments" in error.event_info) {
                    return error.event_info.arguments[0];
                }
            }

            return "Unknown Error";
        }

        function createBarChart(page) {
            console.log(`createBarChart(${page.page})`);
            //  Create a bar chart showing the frequency of each error message
            //  x-axis: error event message string
            //  y-axis: frequency of error event message
            //  The chart x-axis should be sorted in non-increasing order of
            //  frequency.

            let errorMessages = {};
            for (let error of page.errors) {
                let errorMessage = getErrorMessage(error);

                if (errorMessage in errorMessages) {
                    errorMessages[errorMessage]++;
                }
                else {
                    errorMessages[errorMessage] = 1;
                }
            }

            console.log(errorMessages);

            let errors = [];
            for (let error in errorMessages) {
                errors.push({
                    msg: error,
                    freq: errorMessages[error]
                });
            }

            errors.sort((e1, e2) => e2.freq - e1.freq);

            let scaleX = [];
            let scaleY = [];
            
            for (let error of errors) {
                scaleX.push(error.msg);
                scaleY.push(error.freq);
            }

            return {
                type: "bar",
                title: {
                    text: "Error Messages By Frequency"
                },
                scaleX: {
                    label: "Error Messages",
                    labels: scaleX
                },
                scaleY: {
                    step: 1
                },
                series: [
                    {
                        values: scaleY,
                        text: "Frequency of error messages",
                        tooltip: {
                            text: "'%kt' occurred %vt times."
                        },
                        backgroundColor: "darkred"
                    }
                ]
            };
        }

        function createGrid(page) {
            console.log(`createGrid(${page.page})`);

            //  Grid that contains a listing of the error events that occurred
            //  on the page.

            let gridData = [];

            for (let error of page.errors) {
                gridData.push({
                    "Message": getErrorMessage(error),
                    "Type": error.event_name,
                    "Error Info": JSON.stringify(error.event_info, null, 2),
                    "Time": error.time_stamp
                });
            }

            return gridData;
        }
        
        function createPageErrorDashboard(page) {
            console.log(`createPageErrorDashboard(${page.page})`);

            let pageSection = document.createElement("section");

            //  Page section structure:
            //  <h2> Page Title </h2>
            //  <h3>Number of Errors on page</h3>
            //  Pie chart of event error types on page
            //  Bar chart showing the frequency of each particular error event
            //  Grid of raw error events.

            //  1.  Add title with number of errors on the page
            let pageTitle = document.createElement("h2");
            pageTitle.innerHTML = 
                `Error Dashboard For <code>${page.page}</code> | Errors: 
                <span style="color: darkred">${page.numErrors}</span>`;
            pageSection.appendChild(pageTitle);

            //  2.  Add Number of Errors on page
            // let numErrorsElement = document.createElement("h3");
            // numErrorsElement.innerHTML = `Errors: 
            //     <span style="color: darkred">${page.numErrors}</span>`;
            // pageSection.appendChild(numErrorsElement);

            //  3.  Add pie and bar graph graphset
            let graphSetElement = document.createElement("div");
            let graphSetID = `graphset-${uniqueIdCounter++}`;
            graphSetElement.id = graphSetID;

            pageSection.appendChild(graphSetElement);

            let graphset = [
                createPieChart(page), createBarChart(page)
            ];

            //  4.  Add grid
            let gridElement = document.createElement("zing-grid");
            let gridElementID = `grid-${uniqueIdCounter++}`;
            gridElement.id = gridElementID;

            gridElement.setAttribute("sort", "");
            gridElement.setAttribute("search", "");
            gridElement.setAttribute("pager", "");
            gridElement.setAttribute("page-size", "5");

            gridElement.innerHTML = `
                <zg-caption>Page Errors</zg-caption>
                <zg-colgroup>
                    <zg-column type="text" index="Message"></zg-column>
                    <zg-column type="text" index="Type"></zg-column>
                    <zg-column type="element" type-element-tag-name="pre" index="Error Info"></zg-column>
                    <zg-column type="date" index="Time" type-date-format="hh:mm:ss, dddd, MMMM Do YYYY" sort-desc="true"></zg-column>
                </zg-colgroup>
            `;

            pageSection.appendChild(gridElement);

            let gridData = createGrid(page);

            return {
                sectionElement: pageSection,
                graphSetID: graphSetID,
                graphset: graphset,
                gridElementID: gridElementID,
                gridData: gridData
            };
        }

        addEventListener("load", async (e) => {
            //  1.  Query ActivityBurst data from the REST API endpoint (need
            //      error data).
            let response = 
                await fetch('https://gilkeidar.com/api/errors');
            let activity = await response.json();

            //  2.  Create a pages object (key->value hashmap where key is page
            //      path and value is an object with a number of errors and an
            //      array of error events).
            let pages = {};
            for (let activity_burst of activity) {
                for (let activity_data of activity_burst.activity) {
                    //  1.  Determine whether activity_data is of an error
                    //      event.
                    if (isErrorEvent(activity_data)) {
                        //  1.  Get page path
                        let page = activity_data.page;

                        //  2.  If the pages object already has this page as a
                        //      key, then log the error event and increment the
                        //      number of events in that page.
                        if (page in pages) {
                            pages[page].numErrors++;
                            pages[page].errors.push(activity_data);
                        }
                        else {
                            //  Create new page object
                            pages[page] = {
                                page: page,
                                numErrors: 1,
                                errors: [ activity_data ]
                            };
                        }
                    }
                }
            }

            //  3.  Convert pages object to array and sort it in descending
            //      order by number of errors
            let pageArray = [];
            for (let page in pages) {
                pageArray.push(pages[page]);
            }

            pageArray.sort((p1, p2) => p2.numErrors - p1.numErrors);

            //  4.  Create a section for each page
            let main = document.querySelector('main');
            for (let page of pageArray) {
                let pageObject = createPageErrorDashboard(page);

                main.appendChild(pageObject.sectionElement);

                //  Render graphset
                zingchart.render({
                    id: pageObject.graphSetID,
                    data: {
                        layout: "horizontal",
                        graphset: pageObject.graphset
                    }
                });

                //  Render grid
                let grid = document.querySelector(`#${pageObject.gridElementID}`);
                grid.setData(pageObject.gridData);
            }
        })
    </script>
</body>
</html>